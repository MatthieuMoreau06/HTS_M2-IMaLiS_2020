---
title: "Microarray"
author: 
 - Gaelle Lelandais, 
 - Stephane Le Crom, stephane.le_crom@sorbonne-universite.fr
 - Matthieu Moreau, matthieu.moreau@inserm.fr
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    toc: yes
    number_sections: true
    toc_float: true
---

# library loading
```{r message=FALSE}
library(marray)
library(limma)
```

# Preprocessing of the raw data : Correction of experimental biases

## Reading of GPR file

```{r}
rawdata <- read.GenePix("dataFile1_normAnalysis.gpr")

```

```{r}
# intensity values in red channel f = foreground
head(rawdata@maRf)
# intensity values in green channel
head(rawdata@maGf)
```

Visualization of foreground signal

```{r}
# Red signals
image(rawdata,
      xvar = "maRf",
      main = "Red signal (with flags)")

# Green signals
image(rawdata,
      xvar = "maGf",
      main = "Red signal (with flags)")
```

Visualization of background signal

```{r message=FALSE, warning=FALSE}
# Red channel background signals
image(rawdata,
      xvar = "maRb",
      main = "Red background (with flags)")

# Green channel background signals
image(rawdata,
      xvar = "maGb",
      main = "Green background (with flags)")
```

## Quality control : flagged spots

Each spot is automaticaly associated with a flag value reorting some quality information

Flag Values :  
 *-50 not found
 *-75 empty
 *-100 bad
 *0 good

### Manipulate flagged spots

Create a toy copy of the rawdata for example purpose

```{r}
copyRawData <- rawdata
table(rawdata@maW)
```

Remove background intensity value for flagged spots

```{r}
copyRawData@maRb[rawdata@maW < 0] = NA
copyRawData@maGb[rawdata@maW < 0] = NA
```

Visualization of background signals without flags

```{r}
image(copyRawData,
      xvar = "maRb",
      main = "Red background (without flag)")

image(copyRawData,
      xvar = "maGb",
      main = "Green background (without flag)")
```

```{r}
# Remove the toy object
rm(copyRawData)
```


### Filter flagged spots

Flag location on the slide

```{r}
MyColor <- maPalette(low = "blue", high = "white" , k = 10)

image(rawdata,
      xvar = "maW",
      col = MyColor,
      zlim = c(min(rawdata@maW), max(rawdata@maW)),
      main = "Location of Flags on the slide")
```

Negatively flagged spots will be eliminated from further analyses by replacing their **intensity values** are replaced by NA (missing values)

```{r}
rawdataWithoutFlags <- rawdata

#Background signal to NA
rawdataWithoutFlags@maRb[rawdataWithoutFlags@maW < 0] = NA
rawdataWithoutFlags@maGb[rawdataWithoutFlags@maW < 0] = NA 

#Signal value to NA
rawdataWithoutFlags@maRf[rawdataWithoutFlags@maW < 0] = NA 
rawdataWithoutFlags@maGf[rawdataWithoutFlags@maW < 0] = NA
```

### Background correction

no background correction is performed here

```{r}
rawdataWithoutFlags@maGb[] = 0
rawdataWithoutFlags@maRb[] = 0
```

## Normalization

Comparison of Cy5 and Cy3 signals

```{r}
plot(rawdataWithoutFlags,legend.func = NULL, main = "MA plot before normalization")
plot(rawdataWithoutFlags, main = "MA plot before normalization")
boxplot(rawdataWithoutFlags, main = "Boxplot before normalization")
```

### Compare the three different procedures for signal normalization

```{r}
rawdataWithoutFlagsNorm <- maNorm(rawdataWithoutFlags, norm = "median", echo = T)
rawdataWithoutFlagsNorm2 <- maNorm(rawdataWithoutFlags, norm = "loess", echo = T)
rawdataWithoutFlagsNorm3 <- maNorm(rawdataWithoutFlags, norm = "printTipLoess", echo = T)
```

Several plots allow for comparison of the normalization methods
```{r}
plot(rawdataWithoutFlagsNorm, legend.func = NULL, main = "norm = Median")
plot(rawdataWithoutFlagsNorm2, legend.func = NULL, main = "norm = Loess")
plot(rawdataWithoutFlagsNorm3, legend.func = NULL, main = "norm = printTipLoess")
```


```{r}
boxplot(rawdataWithoutFlagsNorm, main = "norm = Median")
boxplot(rawdataWithoutFlagsNorm2, main = "norm = Loess")
boxplot(rawdataWithoutFlagsNorm3, main = "norm = printTipLoess")
```


```{r}
plot(density(maM(rawdataWithoutFlagsNorm2),na.rm = T),
     lwd = 2, col = 2, main = "Distribution of log(Ratio)")
lines(density(maM(rawdataWithoutFlags), na.rm = T), lwd = 2)
abline(v = 0)
legend(-10.7,0.8,c("Before normalization","After normalization with loess"), fill = c(1,2))

```

# Search for differentially expressed genes

## Load the matrix containing the normalized log ratio intensity value for each replicates

```{r}
dataFile <- "dataFile_diffAnalysis.txt"
data <- as.matrix(read.table(dataFile, row.names = 1, header = T))
```

```{r}
dim(data)
data[1:10,1:4]
```

## Perform statistical test

```{r}
# Linear model estimation
fit <- lmFit(data)

# Bayesian statistics
limma.res <- eBayes(fit)
```

```{r}
head(topTable(limma.res))
```


## Selection of differentially expressed genes (p-vlaue threshold = 0.01 here)

```{r}
allgenes.limma <- topTable(limma.res, number = nrow(data)) # Retreive result table for all genes
siggenes.limma <- allgenes.limma[allgenes.limma[,5] < 0.01,] # Filter on the adj.P.Val

paste(dim(siggenes.limma[siggenes.limma[,2] > 0,])[1], "upregulated genes (logFC value > 0)")
paste(dim(siggenes.limma[siggenes.limma[,2] < 0,])[1], "downpregulated genes (logFC value < 0)")
```

```{r eval=FALSE, include=FALSE}
write.table(siggenes.limma[siggenes.limma[,2] > 0,], 
            row.names = T, quote = F, sep = "\t",
            file = "limma_up_signif_genes.txt")

write.table(siggenes.limma[siggenes.limma[,2] < 0,], 
            row.names = T, quote = F, sep = "\t",
            file = "limma_low_signif_genes.txt")
```

## Plot results of the DE analysis

Volcano plot

```{r}
attach(allgenes.limma)

volcanoplot(limma.res, main = "Hypoxic  VS normoxic ",pch =21)
abline(v = c(-2,2), col = "red")
abline(h = 1.3, col= "red", lty =2)
points(siggenes.limma$logFC[logFC >2 & adj.P.Val < 0.05], -1 * log10(siggenes.limma$P.Value[logFC >2  & adj.P.Val < 0.05]), col ="red")
points(siggenes.limma$logFC[logFC <(-2) & adj.P.Val < 0.05], -1 * log10(siggenes.limma$P.Value[logFC <(-2)  & adj.P.Val < 0.05]), col ="green")
legend("topleft", c("11 genes with LogFC > 2 in hypoxic VS normoxic", "78 genes with LogFc > 2 in normoxic VS hypoxic"),pch = 21, col = c("green", "red"), bty ="n", cex =.9)

```


# Reproductibility
```{r}
#date
format(Sys.time(), "%d %B, %Y, %H,%M")

#Packages used
sessionInfo()
```