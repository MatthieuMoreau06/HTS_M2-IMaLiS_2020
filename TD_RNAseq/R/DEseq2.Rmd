---
title: "DE analysis using DEseq2"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
# library loading
library(DESeq2)
```

```{r}
# data reading
countData = read.table("/shared/projects/ens_HTseq_2020/RNAseq/R/count_data_diffAnalysis.txt", row.names = 1, header = TRUE)

# general information
row.names(countData)
head(countData)
```

```{r}
# Loading metadata for the experiment
# N = Normoxic condition (with O2)
# H = Hypoxic condition  (without O2)
colData = read.table("/shared/projects/ens_HTseq_2020/RNAseq/R/design.txt", row.names = 1, header = TRUE)

```

```{r}
# DESeqDataSet object creation
dds = DESeqDataSetFromMatrix(countData = countData, colData = colData, design = ~condition)
head(dds)

```

```{r}
# normalization of counts
# calculation of sizeFactors
dds = estimateSizeFactors(dds)
sizeFactors(dds)
```

```{r}
# bar plots
barplot(colSums(counts(dds)))
```

```{r}
# boxplots
boxplot(log2(counts(dds)+1))
boxplot(log2(counts(dds,normalized=TRUE)+1))
```

```{r}
# variance estimations
dds = estimateDispersions(dds)
plotDispEsts(dds)
```

```{r}
# differential analysis
dds = nbinomWaldTest(dds)
res = results(dds)
mcols(res,use.names=TRUE)
resultsNames(dds)
res <- as.data.frame(res)
```


```{r}
# diagnostic plots
attach(res)

#volcano plot
plot(log2FoldChange, -log10(padj),pch =21, main = "Normoxic VS Hypoxic")
abline(v = c(-2,2), col ="red")
abline(h = 1.3, col= "red", lty =2)
points(log2FoldChange[log2FoldChange >2 & padj < 0.05], -1 * log10(padj[log2FoldChange >2  & padj < 0.05]), col ="green")
points(log2FoldChange[log2FoldChange <(-2) & padj < 0.05], -1 * log10(padj[log2FoldChange <(-2)  & padj < 0.05]), col ="red")
legend("topright", c("107 genes with LogFc  > 2 in Hypoxic VS normoxic", " 85 genes with LogFc  > 2 in normoxic VS hypoxic"),pch = 21, col = c("red", "green"), bty ="n", cex =.9)
```

```{r}
FoldFc_sup2 <- res[res[,2] < (-2) & res[,5] <0.05,]
nrow(FoldFc_sup2)
write.table(FoldFc_sup2, row.names = T, quote = F, sep = "\t", file = "../results/RNAseq_FoldFc_sup2.txt")

```

```{r}
FoldFc_inf2 <- res[res[,2] <(-2),]
nrow(FoldFc_inf2)
```

```{r}
# MA plot
plotMA(res)
```

```{r}
# Histogram of the p values
hist(res$pvalue,breaks=20,col="grey")
# PCA plots
vsd <- varianceStabilizingTransformation(dds, blind=TRUE)
p = plotPCA(vsd)
p = update(p, panel = function(x, y, ...) {lattice::panel.xyplot(x, y, ...);lattice::ltext(x=x, y=y, labels=rownames(colData(vsd)), pos=1, offset=1, cex=0.8)})
print(p)
```

```{r}
# genes are sorted according to adjusted p-values
res = res[order(res$padj),]
dim(res)
res[rownames(res) == "CPAR2_212440",]

write.table(res, "res.txt", row.name=T, quote=F, sep='\t')
```

# Reproductibility
```{r}
#date
date()

#Packages used
sessionInfo()
```